"use strict";function _get(e,t,s){return(_get="undefined"!=typeof Reflect&&Reflect.get?Reflect.get:function(e,t,s){var n=_superPropBase(e,t);if(n){var r=Object.getOwnPropertyDescriptor(n,t);return r.get?r.get.call(s):r.value}})(e,t,s||e)}function _superPropBase(e,t){for(;!Object.prototype.hasOwnProperty.call(e,t)&&null!==(e=_getPrototypeOf(e)););return e}function _createSuper(e){return function(){var t,s=_getPrototypeOf(e);if(_isNativeReflectConstruct()){var n=_getPrototypeOf(this).constructor;t=Reflect.construct(s,arguments,n)}else t=s.apply(this,arguments);return _possibleConstructorReturn(this,t)}}function _possibleConstructorReturn(e,t){return!t||"object"!==_typeof(t)&&"function"!=typeof t?_assertThisInitialized(e):t}function _assertThisInitialized(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}function _isNativeReflectConstruct(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],(function(){}))),!0}catch(e){return!1}}function _getPrototypeOf(e){return(_getPrototypeOf=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function _inherits(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&_setPrototypeOf(e,t)}function _setPrototypeOf(e,t){return(_setPrototypeOf=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function _typeof(e){return(_typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _defineProperties(e,t){for(var s=0;s<t.length;s++){var n=t[s];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}function _createClass(e,t,s){return t&&_defineProperties(e.prototype,t),s&&_defineProperties(e,s),e}var QuestalEvents=function(){function e(t,s){_classCallCheck(this,e),this.target=t,this.caller=s||t}return _createClass(e,[{key:"on",value:function(e,t){e=e.split(" ");var s=this;return e.forEach((function(e){s.target.addEventListener(e,(function(e){var n=e.detail||s.target;t.call(s.caller,n,e)}))})),this}},{key:"off",value:function(e,t){return"function"==typeof t&&t.name&&(t=t.name),this.target.removeEventListener(e,t),this}},{key:"fire",value:function(e,t,s){var n=this.getCustomEvent();s=s||{},this.target.dispatchEvent(new n(e,{bubbles:s.bubbles||!1,detail:t||s.detail||null,cancelable:s.cancelable||!1,composed:s.composed||!1}))}},{key:"_customEventPolyfill",value:function(){return function(e,t){t=t||{bubbles:!1,cancelable:!1,detail:null};var s=document.createEvent("CustomEvent");return s.initCustomEvent(e,t.bubbles,t.cancelable,t.detail),s}}},{key:"getCustomEvent",value:function(){return"function"==typeof window.CustomEvent?window.CustomEvent:this._customEventPolyfill()}}]),e}(),QuestalUtil=function(){function e(){_classCallCheck(this,e)}return _createClass(e,null,[{key:"getType",value:function(e){return e instanceof RegExp?"regex":"object"===_typeof(e)?null==e?"null":Array.isArray(e)?"array":"object":_typeof(e)}},{key:"typecheck",value:function(e,t){var s;switch(t=t||"string"){case"array":s=Array.isArray(e);break;case"object":s="object"===_typeof(e)&&null!=e&&!Array.isArray(e);break;case"regex":s=e instanceof RegExp;break;case"null":s=!e;case"undefined":case"false":break;case"true":s=!!e;break;default:s=_typeof(e)===t}return!!s}},{key:"toCamelCase",value:function(e){return(e=e||"").split("-").map((function(e,t){return t>0?e.substring(0,1).toUpperCase()+e.substring(1):e})).join("").trim()}},{key:"ucfirst",value:function(e){return e&&"string"==typeof e?e.substring(0,1).toUpperCase()+e.substring(1).toLowerCase():e}},{key:"Request",get:function(){var e;if("object"===("undefined"==typeof exports?"undefined":_typeof(exports))&&"undefined"!=typeof module&&"function"==typeof QuestalModule)e=QuestalModule;else{if("function"!=typeof XMLHttpRequest)throw new Error("Questal is not supported in this environment");e=QuestalRequest}return e}}]),e}(),QuestalData=function(){function e(){_classCallCheck(this,e)}return _createClass(e,[{key:"setData",value:function(e){this._data||(this._data={}),this._params||(this._params="");var t={},s="",n=QuestalUtil.getType(e);"object"==n?(t=e,s=this.parseParamsToString(e)):"string"==n&&(t=this.parseParamsToObject(e),s=e),this._data=Object.assign({},this._data,t),this._params+=s}},{key:"parseParamsToObject",value:function(e){return"?"==(e=e||"").substring(0,1)&&(e=e.substring(1)),e.split("&").reduce((function(e,t){var s=t.split("=");return e[decodeURIComponent(s[0])]=decodeURIComponent(s[1]),e}),{})}},{key:"parseParamsToString",value:function(e,t){return e=e||{},(t?"?":"")+Object.keys(e).map((function(t){return encodeURIComponent(t)+"="+encodeURIComponent(e[t])})).join("&")}},{key:"data",set:function(e){this.setData(e)},get:function(){return this._data||{}}},{key:"params",set:function(e){this.setData(e)},get:function(){return this._params||""}}]),e}(),QuestalHeaders=function(){function e(t){_classCallCheck(this,e),this.settings=t,this.headers={}}return _createClass(e,[{key:"set",value:function(e,t){return"accept"==e.toLowerCase()?this.accept=t:"encoding"==e||"Content-Type"==e||"content"==e?this.encoding=t:this.isForbidden(e)||(this.headers[e]=t),this}},{key:"init",value:function(){if(this.sendable){for(var e=Object.keys(this.headers),t=0;t<e.length;t++){var s=e[t],n=this.headers[s];this.isForbidden(s)||this.settings.setRequestHeader(s,n)}this.accept&&this.settings.setRequestHeader("Accept",this.accept),this.encoding&&this.settings.setRequestHeader("Content-Type",this.encoding)}return this}},{key:"isForbidden",value:function(e){if((e=e.trim()).startsWith("Sec-")||e.startsWith("Proxy-"))return!0;return!!["Accept-Charset","Accept-Encoding","Access-Control-Request-Headers","Access-Control-Request-Method","Connection","Content-Length","Cookie","Cookie2","Date","DNT","Expect","Host","Keep-Alive","Origin","Referer","TE","Trailer","Transfer-Encoding","Upgrade","Via"].includes(e)}},{key:"sendable",value:function(){return!(this.settings.readyState>=2)}},{key:"_parseAccept",value:function(e){var t;switch(e){case"json":t="application/json";break;case"html":t="text/html";break;case"xml":t="application/xml, application/xhtml+xml";break;case"plain":t="text/plain";break;default:t=e}this._accept.includes(t)||this._accept.push(t)}},{key:"accept",set:function(e){if(this._accept||(this._accept=[]),Array.isArray(e)){if(e.includes("*")||e.includes("*/*"))return void(this._accept=["*/*"]);var t=this;e.forEach((function(e){t._parseAccept(e)}))}else{if(["*","*/*"].includes(e))return void(this._accept=["*/*"]);this._parseAccept(e)}},get:function(){return this._accept||(this._accept=[]),this._accept.includes("*/*")?"*/*":this._accept.join(",")}},{key:"encoding",set:function(e){switch(e){case"multipart":this._encoding="multipart/form-data";case"form":break;case"plain":this._encoding="text/plain";break;default:this._encoding="application/x-www-form-urlencoded"}},get:function(){return this._encoding?this._encoding:"application/x-www-form-urlencoded"}}]),e}(),QuestalResponse=function(){function e(t,s){_classCallCheck(this,e),this.hasBody=!s,this.settings=t,this.defaultType="text",this.types=["arraybuffer","blob","document","text","json"]}return _createClass(e,[{key:"isSuccess",value:function(){var e=this.code;return e>=200&&e<300}},{key:"success304",value:function(e){return 304==e&&console.warn("Response Code 304: Server returned cached version of data"),e>=200&&(e<300||304==e)}},{key:"headers",get:function(){var e=this.settings.getAllResponseHeaders(),t={};return e&&(t=e.split("\r\n").reduce((function(e,t){var s=t.split(":");if(s&&2==s.length){var n=QuestalUtil.toCamelCase(s[0]);if(["contentType","cacheControl"].includes(n)){var r="contentType"==n?";":",",i=s[1].split(r),o=i[0].trim();if(e[n]=o,"contentType"==n&&(e.encoding=o.split("/")[1]),i.length>1){var a=i[1].split("=");if(a.length>1)e[QuestalUtil.toCamelCase(a[0])]=a[1].trim()}}else e[n]=s[1].trim()}return e}),{})),this.type&&(t.responseType=this.type),t}},{key:"url",get:function(){return this.settings.responseURL}},{key:"result",get:function(){return this.hasBody?["","text"].includes(this.type)?this.settings.responseText:this.settings.response:this.headers}},{key:"text",get:function(){if(!this.hasBody)return"";var e=this.json;try{return JSON.stringify(e)}catch(t){return e.toString()}}},{key:"json",get:function(){if(!this.hasBody)return[];var e=this.result;try{var t=JSON.parse(e);return"string"==typeof t?JSON.parse(t):t}catch(t){return e}}},{key:"xml",get:function(){return this.hasBody?this.settings.responseXML:""}},{key:"html",get:function(){return this.hasBody&&"document"==this.type?this.settings.responseXML:""}},{key:"type",set:function(e){e="buffer"==e?"arraybuffer":e,this.types.includes(e)&&this.settings.readyState<2?this.settings.responseType=e:this.types.includes(e)?console.error("Can't set "+e+". Headers already sent"):console.error("Type ".concat(e," is not a valid response type"))},get:function(){return this.settings.responseType}},{key:"status",get:function(){return this.settings.statusText}},{key:"code",get:function(){return this.settings.status}}]),e}(),QuestalRequest=function(){function e(t,s){_classCallCheck(this,e),this._init(t,s)}return _createClass(e,[{key:"get",value:function(e){return this.settings[e]}},{key:"set",value:function(e,t){switch(e){case"credentials":this.settings.withCredentials=t;break;default:this.settings[e]=t}return this}},{key:"open",value:function(e,t){this._presend(e,t);var s=this.method.toUpperCase();return this.settings.open(s,this.url),this}},{key:"send",value:function(e){if("ready"!=this.state)throw new Error('Request can\t be sent with a ready state of "'.concat(this.state,'".'));return this.settings.send(e),this}},{key:"on",value:function(e,t){["progress","abort","error","timeout"].includes(e)&&(e="_"+e),this.events.on(e,t)}},{key:"off",value:function(e,t){["progress","abort","error","timeout"].includes(e)&&(e="_"+e),this.events.off(e,t)}},{key:"abort",value:function(){return this.settings.abort(),this}},{key:"onLoad",value:function(){var e=this;this.on("load",(function(){e.events.fire("complete",e.response),e.success&&e.events.fire("success",e.response)}))}},{key:"onChange",value:function(){var e=this;this.on("readystatechange",(function(){switch(e.events.fire("change"),e.state){case"ready":e.events.fire("ready");break;case"responseHeaders":e.events.fire("responseHeaders",e.response.headers);break;case"loadStart":e.events.fire("loadStart")}}))}},{key:"onReady",value:function(){this.on("ready",(function(){this.headers.init()}))}},{key:"_init",value:function(e,t){var s=this;this.options=e||{},this.settings=new XMLHttpRequest,this.headers=new QuestalHeaders(this.settings),this.response=new QuestalResponse(this.settings,t),this.events=new QuestalEvents(this.settings,this),this.eventNames=["init","ready","responseHeaders","loadStart","change","complete","success","progress","abort","error","timeout"],this.data=new QuestalData,this.url=this.options.url,this.method=this.options.method||"get",this.data.params=this.options.data||this.options.params,this.set("timeout",this.options.timeout||6e4),this.onLoad(),this.onChange(),this.on("progress",(function(e){s.events.fire("_progress",e)})),this.on("abort",(function(){s.events.fire("_abort")})),this.on("error",(function(e){s.events.fire("_error",e)})),this.on("timeout",(function(){s.events.fire("_timeout")})),this.onReady(),this.setOptions(this.options)}},{key:"setOptions",value:function(e){e=e||{};for(var t=Object.keys(e),s=0;s<t.length;s++){var n=t[s],r=e[n];this.eventNames.includes(n)?this.on(n,r):this.set(n,r)}}},{key:"_presend",value:function(e,t){if(e&&(this.url=e),t&&(this.data.params=t),this.events.fire("init"),this.method){if(this.url)return!0;throw new Error("Request Url is invalid")}throw new Error("Request method is empty")}},{key:"success",set:function(e){"function"==typeof e&&(this._success=e)},get:function(){return"complete"!=!this.state&&(this._success&&"function"==typeof this._success?this._success(this.response.code):this.response.isSuccess())}},{key:"method",set:function(e){e=e||"",this._method=e},get:function(){return this._method||null}},{key:"url",set:function(e){var t=(e=e||"/").split("?");this._url=t[0],t.length>1&&(this.data.params=t[1])},get:function(){return this._url||"/"}},{key:"state",get:function(){return["unsent","ready","responseHeaders","loadStart","complete"][this.settings.readyState]}},{key:"options",set:function(e){e=e||{},this._options||(this._options={}),this._options=Object.assign({},this._options,e)},get:function(){return this._options||{}}}]),e}(),QuestalGet=function(e){_inherits(s,QuestalRequest);var t=_createSuper(s);function s(e){var n;return _classCallCheck(this,s),(n=t.call(this,e)).success=n.response.success304,n}return _createClass(s,[{key:"open",value:function(){return null}},{key:"send",value:function(e,t){_get(_getPrototypeOf(s.prototype),"open",this).call(this,e,t),_get(_getPrototypeOf(s.prototype),"send",this).call(this)}},{key:"_onReady",value:function(e){var t=this;this.on("ready",(function(){var s=e.accept||["plain","xml","html"];t.headers.accept=s,t.headers.init()}))}},{key:"method",get:function(){return"get"},set:function(e){}},{key:"url",set:function(e){var t=(e=e||"/").split("?");this._url=t[0],t.length>1&&(this.data.params=t[1])},get:function(){return this.data.params?this._url+"?"+this.data.params:this._url}}]),s}(),QuestalPost=function(e){_inherits(s,QuestalRequest);var t=_createSuper(s);function s(e){var n;return _classCallCheck(this,s),(n=t.call(this,e)).success=n.response.success304,n}return _createClass(s,[{key:"open",value:function(){return null}},{key:"send",value:function(e,t){_get(_getPrototypeOf(s.prototype),"open",this).call(this,e,t),_get(_getPrototypeOf(s.prototype),"send",this).call(this,this.data.params)}},{key:"onReady",value:function(e){var t=this;e=e||this.options,this.on("ready",(function(){var s=e.accept||["application/json"];t.headers.accept=s,t.headers.init()}))}},{key:"method",get:function(){return"post"},set:function(e){}}]),s}(),QuestalDelete=function(e){_inherits(s,QuestalRequest);var t=_createSuper(s);function s(e){return _classCallCheck(this,s),t.call(this,e)}return _createClass(s,[{key:"open",value:function(){return null}},{key:"send",value:function(e,t){_get(_getPrototypeOf(s.prototype),"open",this).call(this,e,t),_get(_getPrototypeOf(s.prototype),"send",this).call(this)}},{key:"_onReady",value:function(e){var t=this;this.on("ready",(function(){t.headers.init()}))}},{key:"method",get:function(){return"delete"},set:function(e){}},{key:"url",set:function(e){var t=(e=e||"/").split("?");this._url=t[0],t.length>1&&(this.data.params=t[1])},get:function(){return this.data.params?this._url+"?"+this.data.params:this._url}}]),s}(),Questal=function(){function e(){_classCallCheck(this,e)}return _createClass(e,[{key:"request",value:function(e,t){if("get"==(e=e?e.toLowerCase():null))return this.get(t);if("post"==e)return this.post(t);var s=new QuestalRequest(t);return s.method=e||null,s}},{key:"get",value:function(e){return new QuestalGet(e)}},{key:"post",value:function(e){return new QuestalPost(e)}},{key:"put",value:function(e,t,s,n){s=this._processOptions(s);var r=this.request("put",s);return n?r:r.open(e,t).send(r.data.params)}},{key:"patch",value:function(e,t,s,n){s=this._processOptions(s);var r=this.request("patch",s);return n?r:r.open(e,t).send(r.data.params)}},{key:"head",value:function(e,t,s){t=this._processOptions(t,"responseHeaders");var n=this.request("head",t);return s?n:n.open(e).send()}},{key:"delete",value:function(e,t,s){t=this._processOptions(t);var n=new QuestalDelete(t);return s?n:t.data?n.send(e,data):n.send(e)}},{key:"_processOptions",value:function(e,t){return t=t||"success","function"==typeof(e=e||{})&&(e[t]=e),e}},{key:"_staticTemplate",value:function(e,t,s,n,r){"function"==typeof s&&(onSuccess=s,onError=onSuccess,s={});var i=this[e];return"function"==typeof i?i(t,s,{success:n,error:r}):null}}],[{key:"Request",value:function(){return QuestalRequest()}},{key:"Get",value:function(e,t,s,n){return"function"==typeof t&&(n=s=t,t={}),new QuestalGet({success:s,error:n}).send(e,t)}},{key:"Post",value:function(e,t,s,n){return"function"==typeof t&&(n=s=t),new QuestalPost({success:s,error:n}).send(e,t)}},{key:"Put",value:function(t,s,n,r){return(new e)._staticTemplate("put",t,s,n,r)}},{key:"Patch",value:function(t,s,n,r){return(new e)._staticTemplate("patch",t,s,n,r)}},{key:"Head",value:function(t,s,n){return(new e).head(t,{success:s,error:n})}},{key:"Delete",value:function(t,s,n){return(new e).delete(t,{success:s,error:n})}}]),e}();